# -*- coding: utf-8 -*-
"""
æ•°æ®å†™å…¥æ¨¡å—
"""

import logging
import pandas as pd
import numpy as np
from datetime import datetime
from pymongo import MongoClient
import requests
from config.cyys_data_processor.config import MONGODB_URI, MONGODB_DB, NOTIFY_API_URL


class DataWriter:
    """æ•°æ®å†™å…¥ç±»"""

    def __init__(self, db_manager):
        self.db_manager = db_manager

    def write_to_mysql(self, data_dict):
        """å†™å…¥æ•°æ®åˆ°MySQL"""
        logging.info("å¼€å§‹å†™å…¥MySQLè¾“å‡ºåº“...")

        for table_name, df in data_dict.items():
            if df is not None and not df.empty:
                self.db_manager.write_to_output_db(df, table_name)

        logging.info("MySQLæ•°æ®å†™å…¥å®Œæˆ")

    def export_to_mongodb(self, sales_data, jingpin_data, diaobo_data):
        """å¯¼å‡ºæ•°æ®åˆ°MongoDB"""
        try:
            # è¿æ¥åˆ° MongoDB æ•°æ®åº“
            client = MongoClient(MONGODB_URI)
            db = client[MONGODB_DB]

            # å†™é”€å”®æ¯›åˆ©è¡¨
            collection = db['sales_data3']
            collection.delete_many({})
            data_dict = sales_data.to_dict('records')
            collection.insert_many(data_dict)

            # å†™ç²¾å“è¡¨
            collection_jp = db['jingpin_data']
            collection_jp.delete_many({})
            jingpin_data = jingpin_data.fillna('')
            data_dict_jp = jingpin_data.to_dict('records')
            collection_jp.insert_many(data_dict_jp)

            # å†™å¤–éƒ¨è°ƒæ‹¨è¡¨
            collection_diao = db['diao_data']
            collection_diao.delete_many({})
            diaobo_data = diaobo_data.fillna('')
            data_dict_diao = diaobo_data.to_dict('records')
            collection_diao.insert_many(data_dict_diao)

            logging.info("æ•°æ®å·²æˆåŠŸå†™å…¥ MongoDB æ•°æ®åº“")

            # å‘é€é€šçŸ¥
            self.send_md_to_person(
                msg=f"âœ… **æ•°æ®å·²æˆåŠŸå†™å…¥ MongoDB æ•°æ®åº“**\n- æ—¥æœŸ: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}"
            )

        except Exception as e:
            logging.error(f"å¯¼å‡ºåˆ°MongoDBå¤±è´¥: {str(e)}")

            # å‘é€é”™è¯¯é€šçŸ¥
            self.send_md_to_person(
                msg=f"âŒ **æ•°æ®å†™å…¥ MongoDB æ•°æ®åº“å¤±è´¥**\n- æ—¥æœŸ: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n- é”™è¯¯ä¿¡æ¯: {str(e)}"
            )

    def send_md_to_person(self, number: str = "LiuYang01", msg: str = ""):
        """å‘é€é€šçŸ¥"""
        try:
            data = {"touser": number, "msg": msg}
            res = requests.post(NOTIFY_API_URL, json=data, timeout=10)
            if res.status_code == 200:
                logging.info(f"ğŸ“¢ é€šçŸ¥å‘é€æˆåŠŸ")
            else:
                logging.warning(f"âš ï¸ é€šçŸ¥å‘é€å¤±è´¥ï¼ŒçŠ¶æ€ç : {res.status_code}, å“åº”: {res.text}")
        except Exception as e:
            logging.error(f"âš ï¸ å‘é€é€šçŸ¥å¼‚å¸¸: {e}")

    def prepare_mongodb_data(self, df_salesAgg_combined, df_jingpin_result):
        """å‡†å¤‡MongoDBå¯¼å‡ºæ•°æ®"""
        # å‡†å¤‡é”€å”®æ•°æ®
        df_salesAgg = df_salesAgg_combined.copy()

        # é‡å‘½ååˆ—
        rename_dict = {
            'å…¬å¸åç§°': 'è®¢å•é—¨åº—',
            'è®¢è½¦æ—¥æœŸ': 'è®¢è½¦æ—¥æœŸ',
            'é”€å”®æ—¥æœŸ': 'å¼€ç¥¨æ—¥æœŸ',
            'è½¦æ¶å·': 'è½¦æ¶å·',
            'è½¦ç³»': 'è½¦è¾†è½¦ç³»',
            'è½¦è¾†é…ç½®': 'è½¦è¾†è½¦å‹',
            'å¤–é¥°é¢œè‰²': 'è½¦è¾†é¢œè‰²',
            'æ‰€å±å›¢é˜Ÿ': 'ä¸šåŠ¡æ¸ é“',
            'é”€å”®äººå‘˜': 'é”€å”®äººå‘˜',
            'è½¦ä¸»å§“å': 'å®¢æˆ·åç§°',
            'å®šé‡‘é‡‘é¢': 'è®¢é‡‘é‡‘é¢',
            'æŒ‡å¯¼ä»·': 'å‚å®¶å®˜ä»·',
            'è£¸è½¦æˆäº¤ä»·': 'è£¸è½¦æˆäº¤ä»·',
            'é”€å”®è½¦ä»·': 'é”€å”®è½¦ä»·',
            'è½¦æ¬¾ï¼ˆå‘ç¥¨ä»·ï¼‰': 'å¼€ç¥¨ä»·æ ¼',
            'æè´§ä»·': 'æœ€ç»ˆç»“ç®—ä»·',
            'ç½®æ¢æ¬¾': 'ç½®æ¢è¡¥è´´ä¿è¯é‡‘',
            'ç²¾å“æ¬¾': 'ç¥¨æ®äº‹åŠ¡é‡‘é¢',
            'ä¿é™©è¿”åˆ©': 'ä¿é™©è¿”åˆ©',
            'ç»ˆç«¯è¿”åˆ©': 'ç»ˆç«¯è¿”åˆ©',
            'è¿”åˆ©åˆè®¡': 'å‚å®¶è¿”åˆ©åˆè®¡',
            'åè¿”å®¢æˆ·æ¬¾é¡¹': 'åè¿”å®¢æˆ·æ¬¾é¡¹',
            'å¢å€¼ç¨åˆ©æ¶¦å·®': 'å¢å€¼ç¨åˆ©æ¶¦å·®',
            'ç¨è´¹': 'ç¨è´¹',
            'æ¯›åˆ©': 'æ¯›åˆ©',
            'è¿”ä»‹ç»è´¹': 'è¿”ä»‹ç»è´¹',
            'æ”¿åºœè¿”å›åŒºè¡¥': 'åŒºè¡¥',
            'é€€ä»£é‡‘åˆ¸': 'é€€ä»£é‡‘åˆ¸',
            'é€€æˆäº¤è½¦è¾†å®šé‡‘ï¼ˆæœªæŠµæ‰£ï¼‰': 'é€€æˆäº¤è½¦è¾†å®šé‡‘ï¼ˆæœªæŠµæ‰£ï¼‰',
            'é€€æŒ‰æ­æŠ¼é‡‘': 'é€€æŒ‰æ­æŠ¼é‡‘',
            'é€€ç½®æ¢è¡¥è´´ä¿è¯é‡‘': 'é€€ç½®æ¢è¡¥è´´ä¿è¯é‡‘',
            'è´¨æŸèµ”ä»˜é‡‘é¢': 'è´¨æŸèµ”ä»˜é‡‘é¢',
            'è´­ä¹°æ–¹å¼': 'è´­ä¹°æ–¹å¼',
            'é‡‘èç±»å‹': 'é‡‘èç±»å‹',
            'é‡‘èæ€§è´¨': 'æŒ‰æ­æ¸ é“',
            'é¦–ä»˜é‡‘é¢': 'é¦–ä»˜é‡‘é¢',
            'è´·æ¬¾é‡‘é¢': 'è´·æ¬¾æ€»é¢',
            'è´·æ¬¾æœŸé™': 'æœŸé™',
            'é‡‘èæ–¹æ¡ˆ': 'æŒ‰æ­äº§å“',
            'è¿”åˆ©ç³»æ•°': 'è¿”åˆ©ç³»æ•°',
            'é‡‘èæœåŠ¡è´¹': 'å®æ”¶é‡‘èæœåŠ¡è´¹',
            'å‚å®¶è´´æ¯é‡‘é¢': 'å‚å®¶è´´æ¯',
            'ç»é”€å•†è´´æ¯é‡‘é¢': 'å…¬å¸è´´æ¯',
            'é‡‘èè¿”åˆ©': 'è¿”åˆ©é‡‘é¢',
            'é‡‘èç¨è´¹': 'é‡‘èç¨è´¹',
            'é‡‘èæ¯›åˆ©': 'é‡‘èæ¯›åˆ©',
            'ä¸Šç‰Œè´¹': 'ä¸Šç‰Œè´¹',
            'ä¸Šç‰Œæˆæœ¬': 'ä¸Šç‰ŒæœåŠ¡è´¹',
            'ä¸Šç‰Œæ¯›åˆ©': 'ä¸Šç‰Œæ¯›åˆ©',
            'äºŒæ‰‹è½¦è¿”åˆ©é‡‘é¢': 'äºŒæ‰‹è½¦è¿”åˆ©',
            'ç½®æ¢æœåŠ¡è´¹': 'ç½®æ¢æœåŠ¡è´¹',
            'èµ é€è£…é¥°é¡¹ç›®': 'èµ é€è£…é¥°é¡¹ç›®',
            'ä¿ƒé”€è´¹ç”¨': 'ä¿ƒé”€è´¹ç”¨',
            'ä¿å…»å‡çº§æˆæœ¬': 'ä¿å…»å‡çº§æˆæœ¬',
            'è£…é¥°æˆæœ¬': 'è£…é¥°æˆæœ¬',
            'è£…é¥°èµ é€åˆè®¡': 'è£…é¥°èµ é€åˆè®¡',
            'å›æ‰£æ¬¾': 'åˆä½œè¿”åˆ©',
            'ä»£å¼€ç¥¨æ”¯ä»˜è´¹ç”¨': 'ç»¼åˆç»“ç®—æœåŠ¡è´¹',
            'è°ƒæ‹¨è´¹': 'è°ƒæ‹¨è´¹',
            'ç¥¨æ®äº‹åŠ¡è´¹-å…¬å¸': 'ç¥¨æ®äº‹åŠ¡è´¹-å…¬å¸',
            'å•è½¦æ¯›åˆ©': 'å•è½¦æ¯›åˆ©'
        }

        df_salesAgg.rename(columns=rename_dict, inplace=True)

        # ç­›é€‰éœ€è¦çš„åˆ—
        columns_needed = [
            'æœåŠ¡ç½‘ç»œ','è½¦æºé—¨åº—','ä¾›åº”å•†','è®¢å•é—¨åº—','è®¢è½¦æ—¥æœŸ','å¼€ç¥¨æ—¥æœŸ','æ”¶æ¬¾æ—¥æœŸ','è½¦æ¶å·','å‘åŠ¨æœºå·','è½¦è¾†è½¦ç³»','è½¦è¾†è½¦å‹',
            'è½¦è¾†é¢œè‰²','ä¸šåŠ¡æ¸ é“','é”€å”®äººå‘˜','é‚€çº¦äººå‘˜','äº¤ä»˜ä¸“å‘˜','ä¸»æ’­äººå‘˜','å®¢æˆ·åç§°','èº«ä»½è¯å·','è”ç³»ç”µè¯','è”ç³»ç”µè¯2','è®¢é‡‘é‡‘é¢',
            'å‚å®¶å®˜ä»·','è£¸è½¦æˆäº¤ä»·','é”€å”®è½¦ä»·','å¼€ç¥¨ä»·æ ¼','æœ€ç»ˆç»“ç®—ä»·','ç½®æ¢è¡¥è´´ä¿è¯é‡‘','ç¥¨æ®äº‹åŠ¡é‡‘é¢','åè¿”å®¢æˆ·æ¬¾é¡¹','ä¿é™©è¿”åˆ©','ç»ˆç«¯è¿”åˆ©',
            'å‚å®¶è¿”åˆ©åˆè®¡','å¢å€¼ç¨åˆ©æ¶¦å·®','ç¨è´¹','æ¯›åˆ©','è´­ä¹°æ–¹å¼','é‡‘èç±»å‹','æŒ‰æ­æ¸ é“','æŒ‰æ­äº§å“','é¦–ä»˜é‡‘é¢','è´·æ¬¾æ€»é¢','æœŸé™','è¿”åˆ©ç³»æ•°','è¿”åˆ©é‡‘é¢',
            'å‚å®¶è´´æ¯','å…¬å¸è´´æ¯','é‡‘èç¨è´¹','å®æ”¶é‡‘èæœåŠ¡è´¹','é‡‘èæ¯›åˆ©','ä¸Šç‰Œè´¹','ä¸Šç‰ŒæœåŠ¡è´¹','ä¸Šç‰Œæ¯›åˆ©','äºŒæ‰‹è½¦æˆäº¤ä»·','äºŒæ‰‹è½¦è¿”åˆ©','ç½®æ¢æœåŠ¡è´¹','ä¿ƒé”€è´¹ç”¨','èµ é€è£…é¥°é¡¹ç›®','è£…é¥°æ”¶å…¥',
            'è£…é¥°æˆæœ¬','å¥—é¤æ˜ç»†','ä¿å…»å‡çº§æˆæœ¬','è£…é¥°èµ é€åˆè®¡','å…¶ä»–æˆæœ¬','è¿”ä»‹ç»è´¹','åˆä½œè¿”åˆ©','ç»¼åˆç»“ç®—æœåŠ¡è´¹','è°ƒæ‹¨è´¹','ç¥¨æ®äº‹åŠ¡è´¹','ç¥¨æ®äº‹åŠ¡è´¹-å…¬å¸',
            'å…¶å®ƒè´¹ç”¨','ç‰¹æ®Šäº‹é¡¹','æ‹–è½¦è´¹ç”¨','åŒºè¡¥','è´¨æŸèµ”ä»˜é‡‘é¢','è°ƒæ•´é¡¹','å•è½¦æ¯›åˆ©','å¼€ç¥¨é—¨åº—','è°ƒå‡ºç±»å‹','é€€ä»£é‡‘åˆ¸','é€€æˆäº¤è½¦è¾†å®šé‡‘ï¼ˆæœªæŠµæ‰£ï¼‰','é€€æŒ‰æ­æŠ¼é‡‘','é€€ç½®æ¢è¡¥è´´ä¿è¯é‡‘'
        ]

        # åªä¿ç•™å­˜åœ¨çš„åˆ—
        existing_columns = [col for col in columns_needed if col in df_salesAgg.columns]
        df_salesAgg = df_salesAgg[existing_columns]

        # æ•°æ®ç±»å‹è½¬æ¢
        float_columns = ['è®¢é‡‘é‡‘é¢', 'å‚å®¶å®˜ä»·', 'è£¸è½¦æˆäº¤ä»·', 'é”€å”®è½¦ä»·', 'å¼€ç¥¨ä»·æ ¼', 'æœ€ç»ˆç»“ç®—ä»·',
                         'ç½®æ¢è¡¥è´´ä¿è¯é‡‘', 'ç¥¨æ®äº‹åŠ¡é‡‘é¢', 'ä¿é™©è¿”åˆ©', 'ç»ˆç«¯è¿”åˆ©', 'å‚å®¶è¿”åˆ©åˆè®¡', 'åè¿”å®¢æˆ·æ¬¾é¡¹',
                         'å¢å€¼ç¨åˆ©æ¶¦å·®', 'ç¨è´¹','æ¯›åˆ©', 'è¿”ä»‹ç»è´¹', 'åŒºè¡¥', 'é€€ä»£é‡‘åˆ¸', 'é€€æˆäº¤è½¦è¾†å®šé‡‘ï¼ˆæœªæŠµæ‰£ï¼‰', 'é€€æŒ‰æ­æŠ¼é‡‘',
                         'é€€ç½®æ¢è¡¥è´´ä¿è¯é‡‘', 'è´¨æŸèµ”ä»˜é‡‘é¢','é¦–ä»˜é‡‘é¢', 'è´·æ¬¾æ€»é¢', 'å®æ”¶é‡‘èæœåŠ¡è´¹', 'å‚å®¶è´´æ¯', 'å…¬å¸è´´æ¯', 'è¿”åˆ©é‡‘é¢', 'é‡‘èç¨è´¹',
                         'é‡‘èæ¯›åˆ©', 'ä¸Šç‰Œè´¹', 'ä¸Šç‰ŒæœåŠ¡è´¹', 'ä¸Šç‰Œæ¯›åˆ©','äºŒæ‰‹è½¦è¿”åˆ©', 'ç½®æ¢æœåŠ¡è´¹', 'ä¿ƒé”€è´¹ç”¨', 'ä¿å…»å‡çº§æˆæœ¬', 'è£…é¥°æˆæœ¬', 'è£…é¥°èµ é€åˆè®¡', 'å…¶ä»–æˆæœ¬',
                         'åˆä½œè¿”åˆ©', 'ç»¼åˆç»“ç®—æœåŠ¡è´¹', 'è°ƒæ‹¨è´¹', 'ç¥¨æ®äº‹åŠ¡è´¹', 'ç¥¨æ®äº‹åŠ¡è´¹-å…¬å¸', 'å•è½¦æ¯›åˆ©','äºŒæ‰‹è½¦æˆäº¤ä»·', 'è£…é¥°æ”¶å…¥', 'è°ƒæ•´é¡¹', 'å…¶å®ƒè´¹ç”¨', 'ç‰¹æ®Šäº‹é¡¹', 'æ‹–è½¦è´¹ç”¨']
        string_columns = ['è½¦æºé—¨åº—', 'ä¾›åº”å•†', 'è®¢å•é—¨åº—', 'è®¢è½¦æ—¥æœŸ', 'å¼€ç¥¨æ—¥æœŸ', 'æ”¶æ¬¾æ—¥æœŸ', 'è½¦æ¶å·', 'å‘åŠ¨æœºå·','è½¦è¾†è½¦ç³»', 'è½¦è¾†è½¦å‹', 'è½¦è¾†é¢œè‰²', 'ä¸šåŠ¡æ¸ é“',
                          'é”€å”®äººå‘˜', 'å®¢æˆ·åç§°', 'èº«ä»½è¯å·', 'è”ç³»ç”µè¯', 'è”ç³»ç”µè¯2', 'é‡‘èç±»å‹', 'è´­ä¹°æ–¹å¼','æŒ‰æ­æ¸ é“', 'æœŸé™', 'æŒ‰æ­äº§å“', 'èµ é€è£…é¥°é¡¹ç›®', 'è¿”åˆ©ç³»æ•°', 'å¥—é¤æ˜ç»†', 'å¼€ç¥¨é—¨åº—',
                          'è°ƒå‡ºç±»å‹', 'é‚€çº¦äººå‘˜', 'äº¤ä»˜ä¸“å‘˜', 'ä¸»æ’­äººå‘˜']

        # è½¬æ¢å­—ç¬¦ä¸²åˆ—
        for col in string_columns:
            if col in df_salesAgg.columns:
                df_salesAgg[col] = df_salesAgg[col].replace('nan', '').fillna('').astype('str')

        # è½¬æ¢æ•°å€¼åˆ—
        for col in float_columns:
            if col in df_salesAgg.columns:
                df_salesAgg[col] = pd.to_numeric(df_salesAgg[col], errors='coerce').fillna(0).round(2).astype(float)

        # è®¾ç½®è¿‡æ»¤æ¡ä»¶
        start_date = datetime(2025, 4, 1)
        # è¿‡æ»¤ç²¾å“æ•°æ®
        df_jingpin_result['æœ€æ—©æ”¶æ¬¾æ—¥æœŸ'] = pd.to_datetime(df_jingpin_result['æœ€æ—©æ”¶æ¬¾æ—¥æœŸ'], errors='coerce',format='mixed')
        filtered_df_jingpin_result = df_jingpin_result[df_jingpin_result['æœ€æ—©æ”¶æ¬¾æ—¥æœŸ'] >= start_date].copy()
        filtered_df_jingpin_result['è®¢å•é—¨åº—'] = np.where(filtered_df_jingpin_result['è®¢å•é—¨åº—'].str.contains('ç›´æ’­åŸºåœ°'), 'ç›´æ’­åŸºåœ°',filtered_df_jingpin_result['è®¢å•é—¨åº—'])

        # å‡†å¤‡è°ƒæ‹¨æ•°æ®
        for col in ['è®¢è½¦æ—¥æœŸ', 'å¼€ç¥¨æ—¥æœŸ']:
            df_salesAgg.loc[:, col] = pd.to_datetime(
                df_salesAgg[col],
                errors='coerce',
                format='mixed'
            )

        df_salesAgg['è®¢å•é—¨åº—'] = np.where(
            df_salesAgg['è®¢å•é—¨åº—'].str.contains('ç›´æ’­åŸºåœ°'),
            'ç›´æ’­åŸºåœ°',
            df_salesAgg['è®¢å•é—¨åº—']
        )

        # ç­›é€‰è°ƒæ‹¨æ•°æ®
        filtered_df = df_salesAgg[df_salesAgg['å¼€ç¥¨æ—¥æœŸ'] >= start_date]

        # è½¬æ¢æ—¥æœŸæ ¼å¼
        for col in ['è®¢è½¦æ—¥æœŸ', 'å¼€ç¥¨æ—¥æœŸ']:
            filtered_df.loc[:, col] = filtered_df[col].apply(
                lambda x: x.strftime('%Y/%m/%d') if pd.notna(x) else None
            )

        # å¯¹äºåŸå§‹æ•°æ®ä¹Ÿè¿›è¡Œæ—¥æœŸæ ¼å¼è½¬æ¢
        for col in ['è®¢è½¦æ—¥æœŸ', 'å¼€ç¥¨æ—¥æœŸ']:
            df_salesAgg.loc[:, col] = df_salesAgg[col].apply(
                lambda x: x.strftime('%Y/%m/%d') if pd.notna(x) else None
            )

        # ç»§ç»­å¤„ç†å…¶ä»–ç­›é€‰
        filtered_df = filtered_df[filtered_df['ä¸šåŠ¡æ¸ é“'].isin(['è°ƒæ‹¨', 'å…¶ä»–'])]

        filtered_df_columns = ['è®¢å•é—¨åº—','è®¢è½¦æ—¥æœŸ','å¼€ç¥¨æ—¥æœŸ','è½¦æ¶å·','è½¦è¾†è½¦ç³»','è½¦è¾†è½¦å‹','è½¦è¾†é¢œè‰²','ä¸šåŠ¡æ¸ é“','é”€å”®äººå‘˜','é‚€çº¦äººå‘˜','äº¤ä»˜ä¸“å‘˜','å®¢æˆ·åç§°','èº«ä»½è¯å·',
                                    'è”ç³»ç”µè¯','è”ç³»ç”µè¯2','è®¢é‡‘é‡‘é¢','å‚å®¶å®˜ä»·','è£¸è½¦æˆäº¤ä»·','é”€å”®è½¦ä»·','å¼€ç¥¨ä»·æ ¼','æœ€ç»ˆç»“ç®—ä»·','ç½®æ¢è¡¥è´´ä¿è¯é‡‘','ç¥¨æ®äº‹åŠ¡é‡‘é¢','åè¿”å®¢æˆ·æ¬¾é¡¹','ä¿é™©è¿”åˆ©',
                                    'ç»ˆç«¯è¿”åˆ©','å‚å®¶è¿”åˆ©åˆè®¡','å¢å€¼ç¨åˆ©æ¶¦å·®','ç¨è´¹','æ¯›åˆ©','ä¸Šç‰Œè´¹','ä¸Šç‰ŒæœåŠ¡è´¹','ä¸Šç‰Œæ¯›åˆ©','è´¨æŸèµ”ä»˜é‡‘é¢','å•è½¦æ¯›åˆ©','å¼€ç¥¨é—¨åº—']

        existing_filtered_columns = [col for col in filtered_df_columns if col in filtered_df.columns]
        filtered_df = filtered_df[existing_filtered_columns]
        return df_salesAgg, filtered_df_jingpin_result, filtered_df